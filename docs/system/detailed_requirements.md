# 詳細要件定義書

## 1. 機能要件詳細

### 1.1 ファイリングロボシステム連携機能

#### 1.1.1 システム統合インターフェース
- **要件ID**: REQ-001
- **概要**: 既存ファイリングロボシステムとの連携
- **詳細**:
  - REST API による連携インターフェース
  - ファイルメタデータの自動取得
  - 送信要求の受信・処理
  - **ファイル転送受信機能**（重要修正）
- **入力**: ファイルID、送信先メールアドレス、送信者情報
- **出力**: 送信要求受付結果、処理状況

#### 1.1.3 ファイル転送受信機能（新規追加）
- **要件ID**: REQ-003
- **概要**: ファイリングロボシステムからのファイル転送受信
- **詳細**:
  - ファイリングロボシステム内のファイルストレージからファイル取得
  - 転送時の暗号化（AES-256）
  - 転送完了の確認・検証
  - 転送エラー時の再試行機能（最大3回）
- **セキュリティ要件**:
  - 転送経路の暗号化（TLS 1.3）
  - ファイル整合性チェック（SHA-256ハッシュ）
  - 転送ログの記録

#### 1.1.2 メタデータ連携機能
- **要件ID**: REQ-002
- **概要**: ファイル情報の自動連携
- **詳細**:
  - ファイル名、サイズ、作成日時の取得
  - 送信者情報、部署情報の取得
  - アクセス権限情報の継承

### 1.2 ファイリングデリバリシステム機能

#### 1.2.1 セキュアファイル保存機能（修正版）
- **要件ID**: REQ-010
- **概要**: 転送受信したファイルの暗号化保存
- **詳細**:
  - ファイリングロボシステムから転送されたファイルの受信
  - AES-256による暗号化
  - ファイリングデリバリシステム内クラウドストレージへの安全な保存
  - 暗号化キーの安全な管理
- **非機能要件**:
  - 最大ファイルサイズ: 10GB
  - 転送受信時間: 1GB あたり2分以内
  - 暗号化処理時間: 1GB あたり30秒以内
  - 保存完了通知: 3秒以内

#### 1.2.2 セキュアリンク生成機能
- **要件ID**: REQ-011
- **概要**: 一意で安全なダウンロードリンクの生成
- **詳細**:
  - UUID v4 による一意ID生成
  - 有効期限設定（デフォルト7日、最大30日）
  - アクセス回数制限（デフォルト3回）
  - IPアドレス制限オプション
- **セキュリティ要件**:
  - リンクの推測困難性確保
  - HTTPS必須
  - リンク無効化機能

#### 1.2.3 OTP生成・認証機能（最終修正版：真の二段階認証）
- **要件ID**: REQ-012
- **概要**: アクセス権限確認成功後のワンタイムパスワード生成・認証
- **詳細**:
  - セキュアリンクアクセス・権限確認成功後にOTP生成
  - **OTP生成直後にOTP入力画面表示**（ユーザビリティ向上）
  - 6桁数字のOTP（暗号学的に安全な乱数）
  - 有効期限: 10分（生成時点から）
  - **メール送信のみ**（同一メールシステム使用）
  - 認証試行回数制限（5回、以降24時間ロック）
- **セキュリティ要件**:
  - TOTP (Time-based One-Time Password) アルゴリズム使用
  - アクセス時点での動的生成（事前生成禁止）
  - ブルートフォース攻撃対策（指数バックオフ）
  - OTP使用後の即時無効化
  - 同一セッションでの複数OTP生成制限

### 1.3 多要素認証システム

#### 1.3.1 認証フロー管理（最終修正版：真の二段階認証）
- **要件ID**: REQ-020
- **概要**: 時間差による段階的認証プロセスの管理
- **詳細**:
  1. **第一段階**: セキュアリンクアクセス・権限確認
  2. **第二段階開始**: アクセス時点でのOTP生成
  3. **即座表示**: OTP入力画面表示（生成直後）
  4. **並行処理**: OTP送信（メール）
  5. **第二段階完了**: OTP入力・検証
  6. **最終認証**: ファイルダウンロード許可
- **セキュリティ強化**:
  - 各段階でのセッション状態管理
  - 段階間のタイムアウト制御（30分）
  - 認証段階のスキップ不可制御
  - **アクセス権限確認失敗時の即座拒否**
- **エラーハンドリング**:
  - リンク無効時の適切なエラー表示
  - アクセス権限確認失敗時の即座拒否
  - OTP認証失敗時の段階的制限（3回→警告、5回→ロック）
  - セッション異常時の自動無効化

#### 1.3.2 アクセス制御機能
- **要件ID**: REQ-021
- **概要**: ファイルアクセス権限の制御
- **詳細**:
  - 送信者による受信者指定
  - IPアドレス制限
  - 時間帯制限オプション
  - ダウンロード回数制限

### 1.4 監査・ログシステム

#### 1.4.1 操作ログ記録機能
- **要件ID**: REQ-030
- **概要**: 全操作の証跡記録
- **記録項目**:
  - タイムスタンプ
  - ユーザーID/IPアドレス
  - 操作内容
  - 対象ファイル情報
  - 操作結果
- **保存期間**: 7年間
- **ログフォーマット**: JSON形式

#### 1.4.2 セキュリティ監視機能
- **要件ID**: REQ-031
- **概要**: 異常アクセスの検知・通知
- **監視項目**:
  - 短時間での大量アクセス
  - 不正なOTP試行
  - 異常なIPアドレスからのアクセス
- **アラート機能**:
  - 管理者への即座通知
  - 自動ブロック機能
  - インシデントレポート生成

## 2. 非機能要件詳細

### 2.1 性能要件

#### 2.1.1 レスポンス時間
| 機能 | 要件 | 測定条件 |
|------|------|----------|
| ファイルアップロード | 1GB あたり 2分以内 | 100Mbps回線 |
| セキュアリンク生成 | 2秒以内 | 通常負荷時 |
| OTP生成・送信 | 5秒以内 | SMS/メール送信含む |
| ファイルダウンロード | 1GB あたり 1分以内 | 100Mbps回線 |
| 認証処理 | 1秒以内 | OTP検証 |

#### 2.1.2 スループット
- **同時接続ユーザー数**: 1,000ユーザー
- **同時ファイルアップロード**: 50件
- **同時ダウンロード**: 200件
- **API呼び出し**: 10,000 req/min

#### 2.1.3 容量要件
- **最大ファイルサイズ**: 10GB
- **ストレージ容量**: 100TB（初期）
- **ログ保存容量**: 10TB/年
- **データベース**: 1TB（初期）

### 2.2 可用性要件

#### 2.2.1 稼働率
- **システム全体**: 99.9%（年間ダウンタイム8.76時間以内）
- **API Gateway**: 99.95%
- **ファイルストレージ**: 99.9%
- **認証システム**: 99.95%

#### 2.2.2 障害復旧
- **RTO (Recovery Time Objective)**: 4時間
- **RPO (Recovery Point Objective)**: 1時間
- **バックアップ頻度**: 日次フルバックアップ、時間次差分
- **DR (Disaster Recovery)**: 異なるリージョンでの冗長化

### 2.3 セキュリティ要件

#### 2.3.1 暗号化要件
- **保存時暗号化**: AES-256-GCM（認証付き暗号化）
- **転送時暗号化**: TLS 1.3（Perfect Forward Secrecy対応）
- **キー管理**: AWS KMS（FIPS 140-2 Level 3 HSM対応）
- **暗号化範囲**: 全ファイル、全通信、全ログ、全メタデータ

#### 2.3.2 認証・認可（真の二段階認証）
- **多要素認証**: 
  - 第一要素：セキュアリンク（知識要素）
  - 第二要素：OTP（所有要素、アクセス時点で生成）
  - 時間差認証による攻撃リスク軽減
- **セッション管理**: 
  - JWT（段階別有効期限：リンクアクセス30分、OTP認証後1時間）
  - セッション固定攻撃対策
  - 同時セッション制限
- **パスワードポリシー**: 管理者用（12文字以上、複雑性要件）
- **アクセス制御**: RBAC + 時間差認証制御

#### 2.3.3 攻撃対策要件（新規追加）
- **時間差攻撃対策**: 
  - OTPの事前生成禁止
  - アクセス時点での動的生成
  - 生成から送信までの最小遅延（1秒以内）
- **中間者攻撃対策**: 
  - Certificate Pinning
  - HSTS (HTTP Strict Transport Security)
  - リンクアクセス時の追加検証
- **リプレイ攻撃対策**: 
  - OTPの一回限り使用
  - セッショントークンのnonce使用
  - タイムスタンプ検証
- **ブルートフォース攻撃対策**: 
  - 指数バックオフ（1回目1秒、2回目2秒、3回目4秒...）
  - IP別試行回数制限
  - CAPTCHA導入（3回失敗後）

#### 2.3.4 監査要件
- **段階別ログ記録**: 
  - リンクアクセス、OTP生成、OTP送信、認証成功/失敗
  - 各段階のタイムスタンプと所要時間
- **ログ改ざん防止**: デジタル署名 + ハッシュチェーン
- **ログ暗号化**: 保存時・転送時
- **監査ログ保存期間**: 7年間
- **コンプライアンス**: ISO/IEC 27001準拠

### 2.4 拡張性要件

#### 2.4.1 水平スケーリング
- **マイクロサービス**: 独立したスケーリング
- **ロードバランサー**: 自動負荷分散
- **データベース**: 読み取りレプリカ、シャーディング対応
- **ストレージ**: オブジェクトストレージ（無制限拡張）

#### 2.4.2 垂直スケーリング
- **CPU**: 必要に応じた自動スケールアップ
- **メモリ**: 動的メモリ割り当て
- **ストレージ**: 自動容量拡張

## 3. インターフェース要件

### 3.1 外部システム連携

#### 3.1.1 ファイリングロボシステム連携API
```json
{
  "endpoint": "/api/v1/filing-delivery/send",
  "method": "POST",
  "request": {
    "file_id": "string",
    "sender_email": "string",
    "recipient_emails": ["string"],
    "expiration_days": "integer",
    "access_limit": "integer",
    "message": "string"
  },
  "response": {
    "delivery_id": "string",
    "secure_link": "string",
    "status": "string",
    "created_at": "datetime"
  }
}
```

#### 3.1.2 OTP送信API
```json
{
  "endpoint": "/api/v1/otp/send",
  "method": "POST",
  "request": {
    "delivery_id": "string",
    "recipient_email": "string",
    "method": "email|sms"
  },
  "response": {
    "otp_id": "string",
    "expires_at": "datetime",
    "status": "string"
  }
}
```

### 3.2 ユーザーインターフェース

#### 3.2.1 受信者用ダウンロードページ
- **URL形式**: `https://domain.com/download/{secure_token}`
- **必要要素**:
  - ファイル情報表示
  - OTP入力フィールド
  - ダウンロードボタン
  - セキュリティ情報表示
- **レスポンシブ対応**: PC/タブレット/スマートフォン

#### 3.2.2 送信者用管理画面
- **機能**:
  - 送信履歴確認
  - ダウンロード状況確認
  - リンク無効化
  - 再送機能
- **アクセス制御**: ファイリングロボシステム経由のみ

## 4. データ要件

### 4.1 データモデル

#### 4.1.1 ファイル配信情報
```sql
CREATE TABLE file_deliveries (
    id UUID PRIMARY KEY,
    file_id VARCHAR(255) NOT NULL,
    sender_email VARCHAR(255) NOT NULL,
    recipient_email VARCHAR(255) NOT NULL,
    secure_token VARCHAR(255) UNIQUE NOT NULL,
    encrypted_file_path TEXT NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_size BIGINT NOT NULL,
    expiration_date TIMESTAMP NOT NULL,
    access_limit INTEGER DEFAULT 3,
    access_count INTEGER DEFAULT 0,
    status VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.1.2 OTP管理
```sql
CREATE TABLE otp_tokens (
    id UUID PRIMARY KEY,
    delivery_id UUID REFERENCES file_deliveries(id),
    otp_code VARCHAR(6) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    used_at TIMESTAMP NULL,
    attempt_count INTEGER DEFAULT 0,
    status VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.1.3 監査ログ
```sql
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY,
    delivery_id UUID REFERENCES file_deliveries(id),
    user_id VARCHAR(255),
    ip_address INET,
    user_agent TEXT,
    action VARCHAR(100) NOT NULL,
    details JSONB,
    timestamp TIMESTAMP DEFAULT NOW()
);
```

### 4.2 データ保護

#### 4.2.1 個人情報保護
- **暗号化対象**: メールアドレス、ファイル名、IPアドレス
- **仮名化**: ユーザーIDのハッシュ化
- **データ保存期間**: 配信完了後90日（ログは7年）
- **削除プロセス**: 自動削除スケジュール

#### 4.2.2 バックアップ・復旧
- **バックアップ方式**: 増分バックアップ
- **バックアップ先**: 異なるリージョン
- **復旧テスト**: 月次実施
- **データ整合性**: チェックサム検証

## 5. 運用要件

### 5.1 監視要件

#### 5.1.1 システム監視
- **監視項目**:
  - CPU使用率、メモリ使用率
  - ディスク使用量、ネットワーク使用量
  - API レスポンス時間
  - エラー率
- **アラート閾値**:
  - CPU使用率: 80%
  - メモリ使用率: 85%
  - API エラー率: 5%
  - レスポンス時間: 3秒

#### 5.1.2 セキュリティ監視
- **監視項目**:
  - 不正アクセス試行
  - 異常なAPI呼び出し
  - ファイルアクセスパターン
- **自動対応**:
  - IP アドレスブロック
  - アカウントロック
  - 管理者通知

### 5.2 保守・運用

#### 5.2.1 定期メンテナンス
- **システム更新**: 月次（セキュリティパッチは即時）
- **データベース最適化**: 週次
- **ログローテーション**: 日次
- **証明書更新**: 自動更新（90日前アラート）

#### 5.2.2 障害対応
- **障害検知**: 自動監視システム
- **エスカレーション**: 重要度に応じた通知
- **復旧手順**: 自動化されたランブック
- **事後分析**: 障害報告書作成

## 6. 技術スタック詳細仕様

### 6.1 確定技術スタックの詳細要件

#### 6.1.1 バックエンド: Spring Boot
- **バージョン**: 3.x 系最新版
- **Javaバージョン**: OpenJDK 17+ (LTS)
- **セキュリティ**: Spring Security 6.x
  - OAuth2 Resource Server
  - JWT Token 処理
  - OTP 認証 (TOTP アルゴリズム)
  - CSRF, XSS, Session Fixation 対策
- **監視**: Spring Boot Actuator + Micrometer
- **API ドキュメント**: OpenAPI 3.0 (Swagger)

#### 6.1.2 データベース: PostgreSQL
- **バージョン**: 15.x 系最新版
- **暗号化要件**:
  - 透明データ暗号化 (TDE): AES-256-GCM
  - 行レベルセキュリティ (RLS) 有効
  - コネクション暗号化: TLS 1.3
- **パフォーマンス設定**:
  - shared_buffers: 25% of RAM
  - effective_cache_size: 75% of RAM
  - max_connections: 200
  - work_mem: 256MB
- **バックアップ**: 日次フル + 時間次差分

#### 6.1.3 キャッシュ: Redis
- **バージョン**: 7.x 系最新版
- **構成**: Redis Cluster (3 Master + 3 Slave)
- **使用用途**:
  - OTP トークン管理 (TTL: 600秒)
  - セッションストア (TTL: 3600秒)
  - API レート制限 (Sliding Window)
  - ファイルメタデータキャッシュ
- **永続化**: RDB + AOF ハイブリッド

#### 6.1.4 フロントエンド: React + TypeScript
- **Reactバージョン**: 18.x 系最新版
- **TypeScriptバージョン**: 5.x 系最新版
- **状態管理**: Redux Toolkit + RTK Query
- **UI フレームワーク**: Material-UI v5
- **セキュリティ**:
  - Content Security Policy (CSP) 対応
  - XSS 対策 (DOMPurify)
  - HTTPS 強制 (HSTS)
- **ビルドツール**: Vite

#### 6.1.5 メッセージング: RabbitMQ
- **バージョン**: 3.12.x 系最新版
- **構成**: クラスター構成 (3ノード)
- **使用キュー**:
  - file.transfer.queue: ファイル転送完了通知
  - otp.generation.queue: OTP生成・送信処理
  - audit.log.queue: 監査ログ非同期処理
- **永続化**: メッセージ永続化有効
- **監視**: Management Plugin + Prometheus

#### 6.1.6 コンテナ: Docker + Kubernetes
- **Docker**: 24.x 系最新版
- **Kubernetes**: 1.28.x 系 (AWS EKS)
- **コンテナイメージ**:
  - Base Image: Eclipse Temurin (OpenJDK)
  - Multi-stage Build で最小化
  - 脆弱性スキャン (Trivy) 組み込み
- **Kubernetes リソース**:
  - HPA (Horizontal Pod Autoscaler)
  - Network Policy (ネットワーク分離)
  - Secret 管理 (AWS Secrets Manager 連携)

### 6.2 AWS サービス詳細仕様

#### 6.2.1 コンピューティング: EKS
- **バージョン**: 1.28
- **ノードグループ**: 
  - アプリケーション: t3.large (2-10ノード)
  - データベース: r5.xlarge (2ノード)
- **アドオン**:
  - AWS Load Balancer Controller
  - EBS CSI Driver
  - AWS Secrets Manager CSI Driver

#### 6.2.2 ストレージ: S3
- **ストレージクラス**: Standard
- **暗号化**: SSE-KMS (AWS KMS)
- **バージョニング**: 有効 (30日保持)
- **ライフサイクルポリシー**:
  - 90日後: Standard-IA
  - 365日後: Glacier Flexible Retrieval
  - 2555日後: Glacier Deep Archive

#### 6.2.3 データベース: RDS PostgreSQL
- **インスタンスタイプ**: db.r5.xlarge
- **Multi-AZ**: 有効
- **暗号化**: 保存時暗号化 + 通信時暗号化
- **バックアップ**: 自動バックアップ (7日保持)
- **メンテナンスウィンドウ**: 日曜 03:00-04:00 JST

#### 6.2.4 キャッシュ: ElastiCache Redis
- **インスタンスタイプ**: cache.r6g.large
- **クラスターモード**: 有効 (3 Shard, 1 Replica)
- **暗号化**: 保存時暗号化 + 通信時暗号化
- **バックアップ**: 日次スナップショット

#### 6.2.5 暗号化: KMS
- **キータイプ**: Customer Managed Key
- **キーローテーション**: 自動 (365日)
- **用途**:
  - S3 バケット暗号化
  - RDS 暗号化
  - ElastiCache 暗号化
  - アプリケーションレベル暗号化

#### 6.2.6 メール: SES
- **送信レート**: 200 emails/second
- **バウンス処理**: SNS 連携
- **テンプレート**: カスタムテンプレート
- **DKIM/SPF**: 設定済み

#### 6.2.7 監視: CloudWatch
- **メトリクス**:
  - アプリケーションメトリクス (Micrometer)
  - インフラメトリクス (EKS, RDS, ElastiCache)
  - カスタムメトリクス (OTP生成数, 認証失敗数)
- **アラート**:
  - エラー率 > 5%
  - レスポンス時間 > 3秒
  - CPU 使用率 > 80%
  - メモリ使用率 > 85%
- **ログ集約**: CloudWatch Logs

#### 6.2.8 セキュリティ: WAF + GuardDuty
- **WAF ルール**:
  - AWS Managed Rules (Core, Known Bad Inputs)
  - Rate Limiting (100 req/5min per IP)
  - Geo Blocking (特定国ブロック)
- **GuardDuty**: 有効 + S3 Protection
- **Security Hub**: 有効 + コンプライアンスチェック

## 7. テスト要件

### 6.1 機能テスト

#### 6.1.1 単体テスト
- **カバレッジ**: 90%以上
- **自動実行**: CI/CD パイプライン組み込み
- **テストデータ**: 匿名化されたサンプルデータ

#### 6.1.2 結合テスト
- **システム間連携**: ファイリングロボシステムとの統合
- **外部サービス**: メール/SMS送信サービス
- **データフロー**: エンドツーエンドテスト

### 7.2 非機能テスト

#### 7.2.1 性能テスト
- **負荷テスト**: 想定負荷の150%
  - Spring Boot: 8,000-12,000 req/sec 目標
  - PostgreSQL: 10,000 QPS 目標
  - Redis: 100,000+ ops/sec 目標
- **ストレステスト**: 限界性能の確認
- **耐久テスト**: 24時間連続運用

#### 7.2.2 セキュリティテスト
- **脆弱性診断**: 第三者機関による実施
  - OWASP Top 10 チェック
  - PostgreSQL セキュリティ診断
  - AWS セキュリティベストプラクティス適合性
- **ペネトレーションテスト**: 年2回実施
  - Spring Security 設定検証
  - OTP 認証フローテスト
  - API セキュリティテスト
- **セキュリティコードレビュー**: 全コード対象
  - Static Application Security Testing (SAST)
  - Dynamic Application Security Testing (DAST)
  - Software Composition Analysis (SCA)

## 8. 技術移行要件

### 8.1 PostgreSQL 移行計画

#### 8.1.1 移行戦略
- **移行方式**: 段階的移行 (Blue-Green デプロイメント)
- **移行期間**: 2024年12月-2025年2月 (2-3ヶ月)
- **並行稼働期間**: 1ヶ月

#### 8.1.2 データ移行手順
1. **スキーマ移行**
   - MySQL から PostgreSQL へのスキーマ変換
   - データ型マッピング (JSON → JSONB 等)
   - インデックス最適化

2. **データ移行**
   - AWS DMS (Database Migration Service) 使用
   - 初期フルロード + 継続レプリケーション
   - データ整合性検証

3. **アプリケーション切り替え**
   - データベースコネクション切り替え
   - クエリ最適化・テスト
   - パフォーマンス検証

#### 8.1.3 リスク対策
- **ロールバック計画**: MySQL への即座切り戻し
- **データ整合性チェック**: 自動検証スクリプト
- **パフォーマンス監視**: 移行前後の比較

### 8.2 Redis 導入計画

#### 8.2.1 導入戦略
- **導入方式**: 段階的導入
- **導入期間**: 2025年1月 (1ヶ月)
- **導入順序**:
  1. OTP トークン管理
  2. セッション管理
  3. API レート制限
  4. ファイルメタデータキャッシュ

#### 8.2.2 既存システムとの統合
- **セッション管理**: 既存システムからの段階的移行
- **フェイルオーバー**: データベースフォールバック
- **モニタリング**: Redis メトリクス監視

### 8.3 Spring Boot アップグレード

#### 8.3.1 アップグレード計画
- **アップグレード期間**: 2025年2月
- **バージョン**: 2.x → 3.x
- **Java バージョン**: 11 → 17
- **Spring Security**: 5.x → 6.x

#### 8.3.2 主要変更点
- **コンフィグレーション**: application.yml 設定更新
- **セキュリティ**: SecurityFilterChain 設定更新
- **メトリクス**: Micrometer 設定更新

## 9. 移行要件

### 9.1 システム移行（ユーザー対応）

#### 9.1.1 パイロット運用
- **対象**: 限定部署（50ユーザー）
- **期間**: 1ヶ月
- **評価項目**: 機能性、使いやすさ、性能

#### 9.1.2 本格運用
- **段階的展開**: 部署単位で順次展開
- **並行運用期間**: 3ヶ月（PPAP方式と併用）
- **完全移行**: 6ヶ月後

### 9.2 ユーザートレーニング

#### 9.2.1 管理者向け
- **システム管理**: 設定、監視、障害対応
- **セキュリティ管理**: ログ分析、インシデント対応
- **ユーザーサポート**: 問い合わせ対応

#### 9.2.2 エンドユーザー向け
- **基本操作**: ファイル送信、受信方法
- **セキュリティ**: OTP認証、注意事項
- **トラブルシューティング**: よくある問題と解決法

---

**文書作成日**: 2024年12月  
**文書バージョン**: 1.0  
**次回更新予定**: 要件レビュー後
